---
layout: post
title: 使用 myActiviti 设计流程图
description: 本章中我们以一个有实际意义的可流转的流程图，来向您介绍工作流最基本的元素。
category: 工作流
date: 2017-12-05
list_number: false
---

## [设计一个可流转的流程](#设计一个可流转的流程图)
我们设想一个公司项目立项的场景：公司内部有 3 个院：A 分院、B 分院和总院；立项起草人在起草好内容后要选择这 3 个大部门之一进行发送；每个院的 TMO（科技管理办公室）首先收到立项请求，TMO 经过审核后可以“同意”继续立项或者“不同意”返回起草人；TMO 同意后会发给本院的财务部，财务部经过审核后可以“同意”立项完成或者“不同意”返回起草人；起草人收到被返回的请求后可以进行结束。

我们简单分析一下这个流程，可知除开始和结束外共需要 7 个环节：起草人、A 分院 TMO、A 分院财务部、B 分院 TMO、B 分院财务部、总院 TMO、总院财务部。同时还需要做 7 次条件判断：起草人环节需要判断是发给哪个院还是直接结束、各院 TMO 需判断同意与否（× 3）、各院财务部需判断同意与否（× 3）。而这 7 次判断涉及到的变量有：`endApply`（起草人是否结束申请）、`nextOU`（起草人发送至哪个院）、`ATmoAgree`(A 分院 tmo 是否同意）、`BTmoAgree`（B 分院 tmo 是否同意）、`TmoAgree`（总院 tmo 是否同意）、`AFinanceAgree`（分院 A 财务部是否同意）、`BFinanceAgree`（分院 B 财务部是否同意）、`FinanceAgree`（总院财务部是否同意）。

将以上信息梳理好后，我们可以建一个名为“myProcess2”的流程图，然后画成如下所示：

{% asset_img 20171215184143259.png %}

这张流程图包含的元素有 `开始事件-普通开始事件`、`任务-用户任务`、`结束事件-普通结束事件`、`网关-互斥网关`、`序列流`，我们还将一条序列流的 `元素名称` 命名为“结束申请”。关于这张图的详细画法我们下面会详细介绍。

## [用户任务和环节参与者](#用户任务和环节参与者)
`用户任务` 是企业级应用中最常用到的一种任务，我们向工作区添加一个用户任务后，在这个任务的输入区至少要指定 3 个属性，如下：

{% asset_img draftTaskInput.png %}

我们要指定 `ID`，以方便业务系统调用这个流程时知道当前流程是哪一个；我们要指定 `元素名称`，以方便在工作区查看这个任务；我们还要指定 `任务分配`，如下：

{% asset_img assign.png %}

在这里我们必须至少指定一个 `候选组`，这是 myActiviti 的约定，因为当您使用微服务调用此流程时，调用参数中的“参与者角色”（dealRole）必须存在于流程图中目标任务的 `候选组` 中才有权限完成任务，所以如果这里为空就没有参与者能通过微服务方式流转这一环节了。
（您应该已经想到，无论是ID “drafter” 还是候选组 “projectManager”，都是先由业务系统定义，然后再写到流程图里的）

如果您在 `文档` 中加入内容，则在返回的 json 中的 "document" 属性也会显示这些内容。

## [排它网关和流程变量](#排它网关和流程变量)
之后我们将接触到一种新的元素——`互斥网关`，它的形状是一个菱形中间加一个 “X”，效果是它发散的多条序列流中最多只有一条能流转，判断能否流转的条件是序列流上的 `序列流条件`。我们以起草环节下面的互斥网关为例，它输出的 4 条序列流为：

| 序列流指向     | 序列流条件   |
|:--------|:-------|
| `总院TMO审核`  | ${endApply == false && nextOU == "M"} |
| `A分院TMO审核` | ${endApply == false && nextOU == "A"} |
| `B分院TMO审核` | ${endApply == false && nextOU == "B"} |
| `结束环节`     | ${endApply == true} |

点击序列流后，在输入区的 `序列流条件` 输入以上条件即可。值得注意的是，我们给指向结束环节的序列流设置了 `元素名称` ，这会让这个序列流在工作区醒目，其它序列流不输入也可以。然后，其它几个网关发散的序列流的表达式分别设为 “${ATmoAgree == true}”、“${BFinanceAgree == false}”……

您可能已经注意到，表达式里 `endApply` 是布尔型变量，而 `nextOU` 是 String 型变量，实际上这里还可以有数字型和时间型变量，这些称之为流程变量。在 myActiviti 中，流程变量不用事先声明，直接在条件表达式中使用就可以，在下一章您将会看到这些变量是如何控制整个流程的走向。

## [以关联业务方式启动流程](#以关联业务方式启动流程)
到现在为止，我们的设计工作已经完成了 90%，剩余的工作就是在流程图的输入区设置 `流程ID` 和 `元素名称`，之后点击保存按钮，<b>然后我们在部署时输入业务标识（例如输入“business2”）</b>并部署：

{% asset_img deploy_2.png %}

这里的 “business2” 是我们为这个流程指定的业务 ID，然后准备工作就全部结束了。相信您早就想运行这个流程了吧，现在在您的浏览器输入 [http://10.0.209.147/microservice/workflow/wfservice/justStart?businessId=business2](http://10.0.209.147/microservice/workflow/wfservice/justStart?businessId=business2) 看看：

```json
{
    "DataRows": [
        {
            "actId": "drafter",
            "actName": "起草",
            "actRole": [
                "projectManager"
            ],
            "document": "您在文档中填写的内容",
            "exeId": "40013",
            "isEnd": "0",
            "procInstId": "40013",
            "taskId": "40016"
        }
    ],
    "RetCode": "1",
    "RetVal": "1",
    "isEnd": "0"
}
```

如果您浏览器上显示的和上面类似（仅仅是 exeId、procInstId 和 taskId 不同），那恭喜您，您的流程图成功的以微服务的方式调用了。

本篇文章中我们只讲述 `justStart` API 的使用，这是一种启动流程的方法，至于流转、挂起、撤回等更复杂操作，我们在下一章进行介绍。